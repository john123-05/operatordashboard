/*\n  # LiftPictures Database Schema\n\n  ## Overview\n  Complete database schema for LiftPictures app with user ride tracking, photo management, favorites, and purchases.\n\n  ## New Tables\n\n  ### 1. rides\n  Tracks user ride timeslots for matching with photos\n  - `id` (uuid, primary key) - Unique ride identifier\n  - `user_id` (uuid, foreign key) - References auth.users, cascade delete\n  - `ride_at` (timestamptz) - When the ride occurred\n  - `source` (text) - How ride was created: 'now', 'manual', or 'qr'\n  - `note` (text, nullable) - Optional user note\n  - `created_at` (timestamptz) - Record creation timestamp\n\n  ### 2. photos\n  Stores metadata for photos from camera/FTP ingestion\n  - `id` (uuid, primary key) - Unique photo identifier\n  - `captured_at` (timestamptz) - When photo was taken\n  - `storage_bucket` (text) - Supabase storage bucket name\n  - `storage_path` (text) - Path within bucket\n  - `created_at` (timestamptz) - Record creation timestamp\n  - Unique constraint on (storage_bucket, storage_path)\n\n  ### 3. favorites\n  User favorites/bookmarks for photos\n  - `id` (uuid, primary key) - Unique favorite identifier\n  - `user_id` (uuid, foreign key) - References auth.users, cascade delete\n  - `photo_id` (uuid, foreign key) - References photos, cascade delete\n  - `created_at` (timestamptz) - When favorited\n  - Unique constraint on (user_id, photo_id)\n\n  ### 4. purchases\n  Purchase records for photo unlocks (minimal scaffold for future payment integration)\n  - `id` (uuid, primary key) - Unique purchase identifier\n  - `user_id` (uuid, foreign key) - References auth.users, cascade delete\n  - `photo_id` (uuid, foreign key) - References photos, cascade delete\n  - `status` (text) - Payment status: 'pending', 'paid', 'failed', or 'refunded'\n  - `provider` (text, nullable) - Payment provider (e.g., 'stripe')\n  - `provider_ref` (text, nullable) - External reference (e.g., checkout_session_id)\n  - `created_at` (timestamptz) - Purchase creation timestamp\n  - Unique constraint on (user_id, photo_id)\n\n  ## Indexes\n\n  ### rides\n  - (user_id, ride_at DESC) - Efficient user ride queries sorted by time\n\n  ### photos\n  - (captured_at DESC) - Efficient photo queries sorted by capture time\n\n  ### favorites\n  - (user_id, created_at DESC) - Efficient user favorites queries\n\n  ### purchases\n  - (user_id, created_at DESC) - Efficient user purchase history queries\n\n  ## Security (Row Level Security)\n\n  ### rides\n  - Enabled RLS\n  - Users can SELECT, INSERT, DELETE their own rides only\n  - No UPDATE policy (rides are immutable after creation)\n\n  ### photos\n  - Enabled RLS\n  - All authenticated users can SELECT (view) photos\n  - INSERT/UPDATE/DELETE restricted (server-side ingestion only)\n\n  ### favorites\n  - Enabled RLS\n  - Users can SELECT, INSERT, DELETE their own favorites only\n\n  ### purchases\n  - Enabled RLS\n  - Users can SELECT their own purchases\n  - Users can INSERT pending purchases\n  - UPDATE/DELETE restricted (server/webhook only)\n\n  ## Views\n\n  ### user_photos_unlocked\n  Helper view showing photos unlocked by current user through paid purchases\n*/\n\n-- Enable required extensions\nCREATE EXTENSION IF NOT EXISTS "pgcrypto";
\n\n-- =====================================================\n-- TABLE: rides\n-- =====================================================\nCREATE TABLE IF NOT EXISTS rides (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  ride_at timestamptz NOT NULL,\n  source text NOT NULL CHECK (source IN ('now', 'manual', 'qr')) DEFAULT 'manual',\n  note text,\n  created_at timestamptz NOT NULL DEFAULT now()\n);
\n\n-- Create index for efficient user ride queries\nCREATE INDEX IF NOT EXISTS idx_rides_user_ride_at ON rides(user_id, ride_at DESC);
\n\n-- Enable RLS\nALTER TABLE rides ENABLE ROW LEVEL SECURITY;
\n\n-- RLS Policies for rides\nDO $$\nBEGIN\n  -- SELECT: Users can view their own rides\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'rides' AND policyname = 'Users can view own rides'\n  ) THEN\n    CREATE POLICY "Users can view own rides"\n      ON rides\n      FOR SELECT\n      TO authenticated\n      USING (auth.uid() = user_id);
\n  END IF;
\n\n  -- INSERT: Users can create their own rides\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'rides' AND policyname = 'Users can create own rides'\n  ) THEN\n    CREATE POLICY "Users can create own rides"\n      ON rides\n      FOR INSERT\n      TO authenticated\n      WITH CHECK (auth.uid() = user_id);
\n  END IF;
\n\n  -- DELETE: Users can delete their own rides\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'rides' AND policyname = 'Users can delete own rides'\n  ) THEN\n    CREATE POLICY "Users can delete own rides"\n      ON rides\n      FOR DELETE\n      TO authenticated\n      USING (auth.uid() = user_id);
\n  END IF;
\nEND $$;
\n\n-- =====================================================\n-- TABLE: photos\n-- =====================================================\nCREATE TABLE IF NOT EXISTS photos (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  captured_at timestamptz NOT NULL,\n  storage_bucket text NOT NULL DEFAULT 'test',\n  storage_path text NOT NULL,\n  created_at timestamptz NOT NULL DEFAULT now(),\n  CONSTRAINT unique_photo_storage UNIQUE(storage_bucket, storage_path)\n);
\n\n-- Create index for efficient photo queries by capture time\nCREATE INDEX IF NOT EXISTS idx_photos_captured_at ON photos(captured_at DESC);
\n\n-- Enable RLS\nALTER TABLE photos ENABLE ROW LEVEL SECURITY;
\n\n-- RLS Policies for photos\nDO $$\nBEGIN\n  -- SELECT: All authenticated users can view photos\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'photos' AND policyname = 'Authenticated users can view photos'\n  ) THEN\n    CREATE POLICY "Authenticated users can view photos"\n      ON photos\n      FOR SELECT\n      TO authenticated\n      USING (true);
\n  END IF;
\nEND $$;
\n\n-- =====================================================\n-- TABLE: favorites\n-- =====================================================\nCREATE TABLE IF NOT EXISTS favorites (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  photo_id uuid NOT NULL REFERENCES photos(id) ON DELETE CASCADE,\n  created_at timestamptz NOT NULL DEFAULT now(),\n  CONSTRAINT unique_user_favorite UNIQUE(user_id, photo_id)\n);
\n\n-- Create index for efficient user favorites queries\nCREATE INDEX IF NOT EXISTS idx_favorites_user_created ON favorites(user_id, created_at DESC);
\n\n-- Enable RLS\nALTER TABLE favorites ENABLE ROW LEVEL SECURITY;
\n\n-- RLS Policies for favorites\nDO $$\nBEGIN\n  -- SELECT: Users can view their own favorites\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'favorites' AND policyname = 'Users can view own favorites'\n  ) THEN\n    CREATE POLICY "Users can view own favorites"\n      ON favorites\n      FOR SELECT\n      TO authenticated\n      USING (auth.uid() = user_id);
\n  END IF;
\n\n  -- INSERT: Users can create their own favorites\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'favorites' AND policyname = 'Users can create own favorites'\n  ) THEN\n    CREATE POLICY "Users can create own favorites"\n      ON favorites\n      FOR INSERT\n      TO authenticated\n      WITH CHECK (auth.uid() = user_id);
\n  END IF;
\n\n  -- DELETE: Users can delete their own favorites\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'favorites' AND policyname = 'Users can delete own favorites'\n  ) THEN\n    CREATE POLICY "Users can delete own favorites"\n      ON favorites\n      FOR DELETE\n      TO authenticated\n      USING (auth.uid() = user_id);
\n  END IF;
\nEND $$;
\n\n-- =====================================================\n-- TABLE: purchases\n-- =====================================================\nCREATE TABLE IF NOT EXISTS purchases (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  photo_id uuid NOT NULL REFERENCES photos(id) ON DELETE CASCADE,\n  status text NOT NULL CHECK (status IN ('pending', 'paid', 'failed', 'refunded')) DEFAULT 'pending',\n  provider text,\n  provider_ref text,\n  created_at timestamptz NOT NULL DEFAULT now(),\n  CONSTRAINT unique_user_purchase UNIQUE(user_id, photo_id)\n);
\n\n-- Create index for efficient user purchase queries\nCREATE INDEX IF NOT EXISTS idx_purchases_user_created ON purchases(user_id, created_at DESC);
\n\n-- Enable RLS\nALTER TABLE purchases ENABLE ROW LEVEL SECURITY;
\n\n-- RLS Policies for purchases\nDO $$\nBEGIN\n  -- SELECT: Users can view their own purchases\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'purchases' AND policyname = 'Users can view own purchases'\n  ) THEN\n    CREATE POLICY "Users can view own purchases"\n      ON purchases\n      FOR SELECT\n      TO authenticated\n      USING (auth.uid() = user_id);
\n  END IF;
\n\n  -- INSERT: Users can create pending purchases\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_policies WHERE tablename = 'purchases' AND policyname = 'Users can create pending purchases'\n  ) THEN\n    CREATE POLICY "Users can create pending purchases"\n      ON purchases\n      FOR INSERT\n      TO authenticated\n      WITH CHECK (auth.uid() = user_id AND status = 'pending');
\n  END IF;
\nEND $$;
\n\n-- =====================================================\n-- VIEW: user_photos_unlocked\n-- =====================================================\nCREATE OR REPLACE VIEW user_photos_unlocked AS\nSELECT \n  p.id as photo_id,\n  p.captured_at,\n  p.storage_bucket,\n  p.storage_path,\n  pur.created_at as unlocked_at\nFROM photos p\nINNER JOIN purchases pur ON pur.photo_id = p.id\nWHERE pur.user_id = auth.uid()\n  AND pur.status = 'paid';
;
