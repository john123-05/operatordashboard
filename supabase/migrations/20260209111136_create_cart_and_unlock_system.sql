/*\n  # Warenkorb und Unlock System\n\n  ## Neue Tabellen\n\n  ### 1. cart_items\n  - Speichert Artikel im Warenkorb des Users\n  - Columns:\n    - id (uuid, primary key)\n    - user_id (uuid, references auth.users)\n    - photo_id (uuid, references photos)\n    - quantity (integer, default 1)\n    - created_at (timestamptz)\n  - Unique constraint: (user_id, photo_id)\n\n  ### 2. purchase_items\n  - Einzelne Artikel eines Kaufs\n  - Columns:\n    - id (uuid, primary key)\n    - purchase_id (uuid, references purchases)\n    - item_type (text: 'photo', 'photopass', 'ticket')\n    - photo_id (uuid, nullable)\n    - product_code (text, nullable)\n    - unit_amount_cents (integer)\n    - quantity (integer)\n    - created_at (timestamptz)\n\n  ### 3. unlocked_photos\n  - Freigeschaltete Fotos für User\n  - Columns:\n    - id (uuid, primary key)\n    - user_id (uuid, references auth.users)\n    - photo_id (uuid, references photos)\n    - unlocked_at (timestamptz)\n  - Unique constraint: (user_id, photo_id)\n\n  ### 4. leaderboard_entries\n  - Leaderboard Einträge (nur für gekaufte Fotos)\n  - Columns:\n    - id (uuid, primary key)\n    - user_id (uuid, references auth.users)\n    - photo_id (uuid, references photos)\n    - speed_kmh (numeric)\n    - ride_date (date)\n    - created_at (timestamptz)\n  - Unique constraint: (user_id, photo_id)\n\n  ## Sicherheit\n  - RLS aktiviert auf allen Tabellen\n  - Users können nur ihre eigenen Daten sehen/ändern\n*/\n\n-- =====================================================\n-- CART_ITEMS TABLE\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS cart_items (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  photo_id uuid REFERENCES photos(id) ON DELETE CASCADE NOT NULL,\n  quantity integer NOT NULL DEFAULT 1,\n  created_at timestamptz NOT NULL DEFAULT now(),\n  CONSTRAINT cart_items_user_photo_unique UNIQUE (user_id, photo_id)\n);
\n\n-- Enable RLS\nALTER TABLE cart_items ENABLE ROW LEVEL SECURITY;
\n\n-- Policies\nCREATE POLICY "Users can view own cart items"\n  ON cart_items FOR SELECT\n  TO authenticated\n  USING (auth.uid() = user_id);
\n\nCREATE POLICY "Users can insert own cart items"\n  ON cart_items FOR INSERT\n  TO authenticated\n  WITH CHECK (auth.uid() = user_id);
\n\nCREATE POLICY "Users can update own cart items"\n  ON cart_items FOR UPDATE\n  TO authenticated\n  USING (auth.uid() = user_id)\n  WITH CHECK (auth.uid() = user_id);
\n\nCREATE POLICY "Users can delete own cart items"\n  ON cart_items FOR DELETE\n  TO authenticated\n  USING (auth.uid() = user_id);
\n\n-- Indexes\nCREATE INDEX IF NOT EXISTS idx_cart_items_user_id ON cart_items(user_id);
\nCREATE INDEX IF NOT EXISTS idx_cart_items_photo_id ON cart_items(photo_id);
\n\n-- =====================================================\n-- PURCHASE_ITEMS TABLE\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS purchase_items (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  purchase_id uuid REFERENCES purchases(id) ON DELETE CASCADE NOT NULL,\n  item_type text NOT NULL CHECK (item_type IN ('photo', 'photopass', 'ticket')),\n  photo_id uuid REFERENCES photos(id) ON DELETE SET NULL,\n  product_code text,\n  unit_amount_cents integer NOT NULL,\n  quantity integer NOT NULL DEFAULT 1,\n  created_at timestamptz NOT NULL DEFAULT now()\n);
\n\n-- Enable RLS\nALTER TABLE purchase_items ENABLE ROW LEVEL SECURITY;
\n\n-- Policies\nCREATE POLICY "Users can view own purchase items"\n  ON purchase_items FOR SELECT\n  TO authenticated\n  USING (\n    EXISTS (\n      SELECT 1 FROM purchases\n      WHERE purchases.id = purchase_items.purchase_id\n      AND purchases.user_id = auth.uid()\n    )\n  );
\n\n-- Indexes\nCREATE INDEX IF NOT EXISTS idx_purchase_items_purchase_id ON purchase_items(purchase_id);
\nCREATE INDEX IF NOT EXISTS idx_purchase_items_photo_id ON purchase_items(photo_id);
\n\n-- =====================================================\n-- UNLOCKED_PHOTOS TABLE\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS unlocked_photos (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  photo_id uuid REFERENCES photos(id) ON DELETE CASCADE NOT NULL,\n  unlocked_at timestamptz NOT NULL DEFAULT now(),\n  CONSTRAINT unlocked_photos_user_photo_unique UNIQUE (user_id, photo_id)\n);
\n\n-- Enable RLS\nALTER TABLE unlocked_photos ENABLE ROW LEVEL SECURITY;
\n\n-- Policies\nCREATE POLICY "Users can view own unlocked photos"\n  ON unlocked_photos FOR SELECT\n  TO authenticated\n  USING (auth.uid() = user_id);
\n\n-- Indexes\nCREATE INDEX IF NOT EXISTS idx_unlocked_photos_user_id ON unlocked_photos(user_id);
\nCREATE INDEX IF NOT EXISTS idx_unlocked_photos_photo_id ON unlocked_photos(photo_id);
\n\n-- =====================================================\n-- LEADERBOARD_ENTRIES TABLE\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS leaderboard_entries (\n  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,\n  photo_id uuid REFERENCES photos(id) ON DELETE CASCADE NOT NULL,\n  speed_kmh numeric NOT NULL,\n  ride_date date NOT NULL,\n  created_at timestamptz NOT NULL DEFAULT now(),\n  CONSTRAINT leaderboard_entries_user_photo_unique UNIQUE (user_id, photo_id)\n);
\n\n-- Enable RLS\nALTER TABLE leaderboard_entries ENABLE ROW LEVEL SECURITY;
\n\n-- Policies (Leaderboard ist öffentlich sichtbar)\nCREATE POLICY "Anyone can view leaderboard entries"\n  ON leaderboard_entries FOR SELECT\n  TO authenticated\n  USING (true);
\n\n-- Indexes\nCREATE INDEX IF NOT EXISTS idx_leaderboard_entries_speed_kmh ON leaderboard_entries(speed_kmh DESC);
\nCREATE INDEX IF NOT EXISTS idx_leaderboard_entries_ride_date ON leaderboard_entries(ride_date DESC);
\nCREATE INDEX IF NOT EXISTS idx_leaderboard_entries_user_id ON leaderboard_entries(user_id);
\n\n-- =====================================================\n-- UPDATE PURCHASES TABLE (if needed)\n-- =====================================================\n\n-- Add total_amount_cents if not exists\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM information_schema.columns\n    WHERE table_schema = 'public' AND table_name = 'purchases' AND column_name = 'total_amount_cents'\n  ) THEN\n    ALTER TABLE purchases ADD COLUMN total_amount_cents integer;
\n  END IF;
\nEND $$;
;
